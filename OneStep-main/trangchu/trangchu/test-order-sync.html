<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test ƒê·ªìng B·ªô ƒê∆°n H√†ng</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button.success {
            background: #27ae60;
        }
        
        button.success:hover {
            background: #229954;
        }
        
        button.danger {
            background: #e74c3c;
        }
        
        button.danger:hover {
            background: #c0392b;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result.success {
            background: #d5f4e6;
            border: 1px solid #27ae60;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #e74c3c;
            color: #721c24;
        }
        
        .result.info {
            background: #d1ecf1;
            border: 1px solid #17a2b8;
            color: #0c5460;
        }
        
        .order-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .order-item.online {
            border-left-color: #27ae60;
        }
        
        .order-item.offline {
            border-left-color: #3498db;
        }
        
        .order-header {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .order-details {
            font-size: 14px;
            color: #7f8c8d;
            line-height: 1.4;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-confirmed {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-shipping {
            background: #e0e7ff;
            color: #3730a3;
        }
        
        .status-delivering {
            background: #fce7f3;
            color: #be185d;
        }
        
        .status-done {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-cancel {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .type-online {
            background: #dcfce7;
            color: #166534;
        }
        
        .type-offline {
            background: #dbeafe;
            color: #1d4ed8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõí Test ƒê·ªìng B·ªô ƒê∆°n H√†ng t·ª´ Trang Ch·ªß l√™n Admin</h1>
        
        <div class="test-section">
            <h2>üìù T·∫°o ƒê∆°n H√†ng Test</h2>
            <p>T·∫°o m·ªôt ƒë∆°n h√†ng m·∫´u ƒë·ªÉ test h·ªá th·ªëng ƒë·ªìng b·ªô:</p>
            
            <div class="form-group">
                <label>T√™n Kh√°ch H√†ng:</label>
                <input type="text" id="customerName" value="Nguy·ªÖn VƒÉn Test" placeholder="Nh·∫≠p t√™n kh√°ch h√†ng">
            </div>
            
            <div class="form-group">
                <label>S·ªë ƒêi·ªán Tho·∫°i:</label>
                <input type="text" id="customerPhone" value="0123456789" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
            </div>
            
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="customerEmail" value="test@example.com" placeholder="Nh·∫≠p email">
            </div>
            
            <div class="form-group">
                <label>ƒê·ªãa Ch·ªâ:</label>
                <input type="text" id="customerAddress" value="123 ƒê∆∞·ªùng Test, Qu·∫≠n 1" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ">
            </div>
            
            <div class="form-group">
                <label>Th√†nh Ph·ªë:</label>
                <select id="customerCity">
                    <option value="hcm">TP. H·ªì Ch√≠ Minh</option>
                    <option value="hanoi">H√† N·ªôi</option>
                    <option value="danang">ƒê√† N·∫µng</option>
                    <option value="other">T·ªânh kh√°c</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>T·ªïng Ti·ªÅn:</label>
                <input type="number" id="orderTotal" value="500000" placeholder="Nh·∫≠p t·ªïng ti·ªÅn">
            </div>
            
            <div class="form-group">
                <label>Ph√≠ Ship:</label>
                <input type="number" id="shippingFee" value="30000" placeholder="Nh·∫≠p ph√≠ ship">
            </div>
            
            <div class="form-group">
                <label>Ghi Ch√∫:</label>
                <textarea id="orderNote" placeholder="Nh·∫≠p ghi ch√∫">ƒê∆°n h√†ng test t·ª´ trang ch·ªß</textarea>
            </div>
            
            <button onclick="createTestOrder()">üõí T·∫°o ƒê∆°n H√†ng Test</button>
            <button onclick="clearResults()" class="danger">üóëÔ∏è X√≥a K·∫øt Qu·∫£</button>
        </div>
        
        <div class="test-section">
            <h2>üìä Ki·ªÉm Tra ƒê∆°n H√†ng tr√™n Admin</h2>
            <p>Ki·ªÉm tra xem ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c ƒë·ªìng b·ªô l√™n admin ch∆∞a:</p>
            
            <button onclick="checkAdminOrders()">üîÑ Ki·ªÉm Tra ƒê∆°n H√†ng Admin</button>
            <button onclick="refreshOrders()" class="success">üîÑ Refresh T·ª± ƒê·ªông</button>
        </div>
        
        <div class="test-section">
            <h2>üìã K·∫øt Qu·∫£ Test</h2>
            <div id="testResults" class="result info">Ch∆∞a c√≥ k·∫øt qu·∫£ test n√†o. H√£y t·∫°o ƒë∆°n h√†ng test ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div>
        </div>
        
        <div class="test-section">
            <h2>üìà Danh S√°ch ƒê∆°n H√†ng</h2>
            <div id="ordersList">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o ƒë∆∞·ª£c t·∫£i.</div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080/api';
        let refreshInterval = null;
        
        // T·∫°o ƒë∆°n h√†ng test
        async function createTestOrder() {
            const resultDiv = document.getElementById('testResults');
            resultDiv.className = 'result info';
            resultDiv.textContent = 'üîÑ ƒêang t·∫°o ƒë∆°n h√†ng test...';
            
            try {
                const orderData = {
                    orderNumber: 'TEST' + Date.now().toString().slice(-6),
                    orderDate: new Date().toISOString(),
                    orderTotal: parseFloat(document.getElementById('orderTotal').value),
                    shippingFee: parseFloat(document.getElementById('shippingFee').value),
                    finalTotal: parseFloat(document.getElementById('orderTotal').value) + parseFloat(document.getElementById('shippingFee').value),
                    paymentMethod: 'Thanh to√°n khi nh·∫≠n h√†ng (COD)',
                    customerInfo: {
                        firstName: document.getElementById('customerName').value.split(' ')[0] || 'Test',
                        lastName: document.getElementById('customerName').value.split(' ').slice(1).join(' ') || 'Customer',
                        email: document.getElementById('customerEmail').value,
                        phone: document.getElementById('customerPhone').value,
                        address: document.getElementById('customerAddress').value,
                        city: document.getElementById('customerCity').value,
                        district: 'Qu·∫≠n Test',
                        note: document.getElementById('orderNote').value
                    },
                    items: [
                        {
                            id: 'TEST001',
                            name: 'S·∫£n ph·∫©m Test',
                            price: parseFloat(document.getElementById('orderTotal').value),
                            quantity: 1,
                            image: '/images/test-product.jpg',
                            brand: 'OneStep'
                        }
                    ],
                    paymentInfo: {
                        id: 'PAY' + Date.now(),
                        maGiaoDich: 'TXN' + Date.now(),
                        trangThai: 1,
                        phuongThucId: 1
                    }
                };
                
                console.log('üì¶ D·ªØ li·ªáu ƒë∆°n h√†ng:', orderData);
                
                // Format d·ªØ li·ªáu cho backend
                const backendData = formatOrderForBackend(orderData);
                console.log('üîÑ D·ªØ li·ªáu g·ª≠i l√™n backend:', backendData);
                
                const response = await fetch(`${API_BASE_URL}/don-hang/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('authToken') || '')
                    },
                    body: JSON.stringify(backendData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ K·∫øt qu·∫£ t·ª´ backend:', result);
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!
                
üìã Th√¥ng tin ƒë∆°n h√†ng:
- M√£ ƒë∆°n: ${orderData.orderNumber}
- Kh√°ch h√†ng: ${orderData.customerInfo.firstName} ${orderData.customerInfo.lastName}
- SƒêT: ${orderData.customerInfo.phone}
- Email: ${orderData.customerInfo.email}
- T·ªïng ti·ªÅn: ${orderData.finalTotal.toLocaleString('vi-VN')} VNƒê
- Lo·∫°i ƒë∆°n: ONLINE (t·ª´ trang ch·ªß)
- Tr·∫°ng th√°i: Ch·ªù x√°c nh·∫≠n

üîÑ Backend Response:
${JSON.stringify(result, null, 2)}

‚è∞ Th·ªùi gian t·∫°o: ${new Date().toLocaleString('vi-VN')}`;
                
                // T·ª± ƒë·ªông ki·ªÉm tra ƒë∆°n h√†ng tr√™n admin sau 2 gi√¢y
                setTimeout(() => {
                    checkAdminOrders();
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå L·ªói khi t·∫°o ƒë∆°n h√†ng:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå L·ªói khi t·∫°o ƒë∆°n h√†ng:
                
${error.message}

üîç Chi ti·∫øt l·ªói:
${error.stack || 'Kh√¥ng c√≥ th√¥ng tin chi ti·∫øt'}

‚è∞ Th·ªùi gian l·ªói: ${new Date().toLocaleString('vi-VN')}`;
            }
        }
        
        // Format d·ªØ li·ªáu ƒë∆°n h√†ng cho backend
        function formatOrderForBackend(orderData) {
            const customerInfo = orderData.customerInfo || {};
            const currentDate = new Date().toISOString().split('T')[0];
            
            return {
                // Th√¥ng tin kh√°ch h√†ng
                khachHangId: 0,
                hoTen: `${customerInfo.firstName || ''} ${customerInfo.lastName || ''}`.trim() || 'Kh√°ch h√†ng',
                soDienThoai: customerInfo.phone || '',
                email: customerInfo.email || '',
                
                // Th√¥ng tin ƒë∆°n h√†ng
                maDon: orderData.orderNumber || 'ORD' + Date.now().toString().slice(-8),
                loaiDon: 1, // 1 = ONLINE (t·ª´ trang ch·ªß)
                tongTien: parseFloat(orderData.finalTotal || orderData.orderTotal || 0),
                tongTienGoc: parseFloat(orderData.orderTotal || 0),
                tienGiam: parseFloat(orderData.discount || 0),
                tienShip: parseFloat(orderData.shippingFee || 0),
                
                // ƒê·ªãa ch·ªâ giao h√†ng
                diaChiGiaoHang: customerInfo.address ? 
                    `${customerInfo.address}, ${customerInfo.district}, ${getCityText(customerInfo.city)}` : '',
                
                // Th√¥ng tin thanh to√°n
                phuongThucThanhToan: orderData.paymentMethod || 'Thanh to√°n khi nh·∫≠n h√†ng (COD)',
                
                // Tr·∫°ng th√°i v√† ng√†y th√°ng
                trangThai: 1, // 1 = Ch·ªù x√°c nh·∫≠n
                ngayXacNhan: currentDate,
                ngayCapNhat: currentDate,
                ngayDuKien: calculateExpectedDeliveryDate(customerInfo.city),
                
                // Th√¥ng tin kh√°c
                ghiChu: customerInfo.note || `ƒê∆°n h√†ng t·ª´ trang ch·ªß - ${new Date().toLocaleString('vi-VN')}`,
                nguoiTao: 'Kh√°ch h√†ng',
                nguoiCapNhat: 'Kh√°ch h√†ng',
                daXoa: 0,
                
                // Chi ti·∫øt ƒë∆°n h√†ng
                chiTietDonHang: formatOrderItemsForBackend(orderData.items || []),
                
                // Th√¥ng tin voucher n·∫øu c√≥
                voucherId: orderData.voucherId || 0,
                maGiamGia: orderData.discountCode || null
            };
        }
        
        // Format chi ti·∫øt ƒë∆°n h√†ng cho backend
        function formatOrderItemsForBackend(items) {
            if (!Array.isArray(items)) return [];
            
            return items.map((item, index) => ({
                id: item.id || Date.now() + index,
                tenSanPham: item.name || 'S·∫£n ph·∫©m',
                gia: parseFloat(item.price || 0),
                soLuong: parseInt(item.quantity || 1),
                kichCo: item.size || 'M·∫∑c ƒë·ªãnh',
                mauSac: item.color || 'M·∫∑c ƒë·ªãnh',
                hinhAnh: item.image || '/images/item-default.jpg',
                brand: item.brand || 'OneStep'
            }));
        }
        
        // T√≠nh ng√†y d·ª± ki·∫øn giao h√†ng
        function calculateExpectedDeliveryDate(city) {
            const currentDate = new Date();
            let deliveryDays = 3; // M·∫∑c ƒë·ªãnh 3 ng√†y
            
            if (city === 'hanoi' || city === 'hcm') {
                deliveryDays = 1; // N·ªôi th√†nh H√† N·ªôi/HCM: 1 ng√†y
            } else if (city === 'danang' || city === 'haiphong' || city === 'cantho') {
                deliveryDays = 2; // Th√†nh ph·ªë l·ªõn: 2 ng√†y
            }
            
            const expectedDate = new Date(currentDate.getTime() + (deliveryDays * 24 * 60 * 60 * 1000));
            return expectedDate.toISOString().split('T')[0];
        }
        
        // L·∫•y t√™n th√†nh ph·ªë
        function getCityText(city) {
            const cityMap = {
                'hanoi': 'H√† N·ªôi',
                'hcm': 'TP. H·ªì Ch√≠ Minh',
                'danang': 'ƒê√† N·∫µng',
                'haiphong': 'H·∫£i Ph√≤ng',
                'cantho': 'C·∫ßn Th∆°',
                'other': 'T·ªânh kh√°c'
            };
            return cityMap[city] || 'T·ªânh kh√°c';
        }
        
        // Ki·ªÉm tra ƒë∆°n h√†ng tr√™n admin
        async function checkAdminOrders() {
            const resultDiv = document.getElementById('testResults');
            const ordersDiv = document.getElementById('ordersList');
            
            try {
                resultDiv.className = 'result info';
                resultDiv.textContent = 'üîÑ ƒêang ki·ªÉm tra ƒë∆°n h√†ng tr√™n admin...';
                
                const response = await fetch(`${API_BASE_URL}/don-hang/hien-thi`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('authToken') || '')
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const orders = Array.isArray(data) ? data : data.data || [];
                
                console.log('üìã ƒê∆°n h√†ng t·ª´ admin:', orders);
                
                // ƒê·∫øm ƒë∆°n h√†ng theo lo·∫°i
                const onlineOrders = orders.filter(order => order.loaiDon === 1);
                const offlineOrders = orders.filter(order => order.loaiDon === 0);
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ ƒê√£ t·∫£i th√†nh c√¥ng danh s√°ch ƒë∆°n h√†ng t·ª´ admin!
                
üìä Th·ªëng k√™:
- T·ªïng ƒë∆°n h√†ng: ${orders.length}
- ƒê∆°n ONLINE (t·ª´ trang ch·ªß): ${onlineOrders.length}
- ƒê∆°n OFFLINE (t·∫°i qu·∫ßy): ${offlineOrders.length}

‚è∞ Th·ªùi gian ki·ªÉm tra: ${new Date().toLocaleString('vi-VN')}`;
                
                // Hi·ªÉn th·ªã danh s√°ch ƒë∆°n h√†ng
                displayOrders(orders);
                
            } catch (error) {
                console.error('‚ùå L·ªói khi ki·ªÉm tra ƒë∆°n h√†ng:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå L·ªói khi ki·ªÉm tra ƒë∆°n h√†ng:
                
${error.message}

‚è∞ Th·ªùi gian l·ªói: ${new Date().toLocaleString('vi-VN')}`;
            }
        }
        
        // Hi·ªÉn th·ªã danh s√°ch ƒë∆°n h√†ng
        function displayOrders(orders) {
            const ordersDiv = document.getElementById('ordersList');
            
            if (orders.length === 0) {
                ordersDiv.innerHTML = '<p>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>';
                return;
            }
            
            // S·∫Øp x·∫øp theo ng√†y t·∫°o m·ªõi nh·∫•t
            orders.sort((a, b) => new Date(b.ngayCapNhat) - new Date(a.ngayCapNhat));
            
            const ordersHTML = orders.map(order => {
                const statusClass = getStatusClass(order.trangThai);
                const statusLabel = getStatusLabel(order.trangThai);
                const typeClass = order.loaiDon === 1 ? 'online' : 'offline';
                const typeLabel = order.loaiDon === 1 ? 'ONLINE' : 'OFFLINE';
                
                return `
                    <div class="order-item ${typeClass}">
                        <div class="order-header">
                            ${order.maDon} 
                            <span class="status-badge status-${statusClass}">${statusLabel}</span>
                            <span class="type-badge type-${typeClass}">${typeLabel}</span>
                        </div>
                        <div class="order-details">
                            <strong>Kh√°ch h√†ng:</strong> ${order.hoTen}<br>
                            <strong>SƒêT:</strong> ${order.soDienThoai}<br>
                            <strong>Email:</strong> ${order.email || 'Ch∆∞a c√≥'}<br>
                            <strong>T·ªïng ti·ªÅn:</strong> ${parseFloat(order.tongTien).toLocaleString('vi-VN')} VNƒê<br>
                            <strong>Ng√†y t·∫°o:</strong> ${new Date(order.ngayCapNhat).toLocaleString('vi-VN')}<br>
                            <strong>ƒê·ªãa ch·ªâ:</strong> ${order.diaChiGiaoHang || 'Ch∆∞a c√≥'}<br>
                            <strong>Ghi ch√∫:</strong> ${order.ghiChu || 'Kh√¥ng c√≥'}
                        </div>
                    </div>
                `;
            }).join('');
            
            ordersDiv.innerHTML = ordersHTML;
        }
        
        // L·∫•y class CSS cho tr·∫°ng th√°i
        function getStatusClass(trangThai) {
            switch (trangThai) {
                case 1: return 'pending';
                case 2: return 'confirmed';
                case 3: return 'shipping';
                case 4: return 'delivering';
                case 5: return 'done';
                case 6: return 'cancel';
                default: return 'pending';
            }
        }
        
        // L·∫•y label cho tr·∫°ng th√°i
        function getStatusLabel(trangThai) {
            switch (trangThai) {
                case 1: return 'Ch·ªù x√°c nh·∫≠n';
                case 2: return 'ƒê√£ x√°c nh·∫≠n';
                case 3: return 'Ch·ªù giao';
                case 4: return 'ƒêang giao';
                case 5: return 'Ho√†n th√†nh';
                case 6: return 'ƒê√£ h·ªßy';
                default: return 'Kh√¥ng x√°c ƒë·ªãnh';
            }
        }
        
        // Refresh t·ª± ƒë·ªông
        function refreshOrders() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(() => {
                checkAdminOrders();
            }, 10000); // Refresh m·ªói 10 gi√¢y
            
            document.getElementById('testResults').className = 'result info';
            document.getElementById('testResults').textContent = 'üîÑ ƒê√£ b·∫≠t ch·∫ø ƒë·ªô refresh t·ª± ƒë·ªông m·ªói 10 gi√¢y. Nh·∫•n "Ki·ªÉm Tra ƒê∆°n H√†ng Admin" ƒë·ªÉ t·∫Øt.';
        }
        
        // X√≥a k·∫øt qu·∫£
        function clearResults() {
            document.getElementById('testResults').className = 'result info';
            document.getElementById('testResults').textContent = 'Ch∆∞a c√≥ k·∫øt qu·∫£ test n√†o. H√£y t·∫°o ƒë∆°n h√†ng test ƒë·ªÉ b·∫Øt ƒë·∫ßu.';
            document.getElementById('ordersList').innerHTML = 'Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o ƒë∆∞·ª£c t·∫£i.';
            
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        // T·ª± ƒë·ªông ki·ªÉm tra khi trang load
        window.onload = function() {
            checkAdminOrders();
        };
    </script>
</body>
</html>
