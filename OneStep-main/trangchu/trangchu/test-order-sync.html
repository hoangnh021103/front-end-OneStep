<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Äá»“ng Bá»™ ÄÆ¡n HÃ ng</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button.success {
            background: #27ae60;
        }
        
        button.success:hover {
            background: #229954;
        }
        
        button.danger {
            background: #e74c3c;
        }
        
        button.danger:hover {
            background: #c0392b;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result.success {
            background: #d5f4e6;
            border: 1px solid #27ae60;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #e74c3c;
            color: #721c24;
        }
        
        .result.info {
            background: #d1ecf1;
            border: 1px solid #17a2b8;
            color: #0c5460;
        }
        
        .order-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .order-item.online {
            border-left-color: #27ae60;
        }
        
        .order-item.offline {
            border-left-color: #3498db;
        }
        
        .order-header {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .order-details {
            font-size: 14px;
            color: #7f8c8d;
            line-height: 1.4;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-confirmed {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-shipping {
            background: #e0e7ff;
            color: #3730a3;
        }
        
        .status-delivering {
            background: #fce7f3;
            color: #be185d;
        }
        
        .status-done {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-cancel {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .type-online {
            background: #dcfce7;
            color: #166534;
        }
        
        .type-offline {
            background: #dbeafe;
            color: #1d4ed8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ›’ Test Äá»“ng Bá»™ ÄÆ¡n HÃ ng tá»« Trang Chá»§ lÃªn Admin</h1>
        
        <div class="test-section">
            <h2>ğŸ“ Táº¡o ÄÆ¡n HÃ ng Test</h2>
            <p>Táº¡o má»™t Ä‘Æ¡n hÃ ng máº«u Ä‘á»ƒ test há»‡ thá»‘ng Ä‘á»“ng bá»™:</p>
            
            <div class="form-group">
                <label>TÃªn KhÃ¡ch HÃ ng:</label>
                <input type="text" id="customerName" value="Nguyá»…n VÄƒn Test" placeholder="Nháº­p tÃªn khÃ¡ch hÃ ng">
            </div>
            
            <div class="form-group">
                <label>Sá»‘ Äiá»‡n Thoáº¡i:</label>
                <input type="text" id="customerPhone" value="0123456789" placeholder="Nháº­p sá»‘ Ä‘iá»‡n thoáº¡i">
            </div>
            
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="customerEmail" value="test@example.com" placeholder="Nháº­p email">
            </div>
            
            <div class="form-group">
                <label>Äá»‹a Chá»‰:</label>
                <input type="text" id="customerAddress" value="123 ÄÆ°á»ng Test, Quáº­n 1" placeholder="Nháº­p Ä‘á»‹a chá»‰">
            </div>
            
            <div class="form-group">
                <label>ThÃ nh Phá»‘:</label>
                <select id="customerCity">
                    <option value="hcm">TP. Há»“ ChÃ­ Minh</option>
                    <option value="hanoi">HÃ  Ná»™i</option>
                    <option value="danang">ÄÃ  Náºµng</option>
                    <option value="other">Tá»‰nh khÃ¡c</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Tá»•ng Tiá»n:</label>
                <input type="number" id="orderTotal" value="500000" placeholder="Nháº­p tá»•ng tiá»n">
            </div>
            
            <div class="form-group">
                <label>PhÃ­ Ship:</label>
                <input type="number" id="shippingFee" value="30000" placeholder="Nháº­p phÃ­ ship">
            </div>
            
            <div class="form-group">
                <label>Ghi ChÃº:</label>
                <textarea id="orderNote" placeholder="Nháº­p ghi chÃº">ÄÆ¡n hÃ ng test tá»« trang chá»§</textarea>
            </div>
            
            <button onclick="createTestOrder()">ğŸ›’ Táº¡o ÄÆ¡n HÃ ng Test</button>
            <button onclick="clearResults()" class="danger">ğŸ—‘ï¸ XÃ³a Káº¿t Quáº£</button>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“Š Kiá»ƒm Tra ÄÆ¡n HÃ ng trÃªn Admin</h2>
            <p>Kiá»ƒm tra xem Ä‘Æ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c Ä‘á»“ng bá»™ lÃªn admin chÆ°a:</p>
            
            <button onclick="checkAdminOrders()">ğŸ”„ Kiá»ƒm Tra ÄÆ¡n HÃ ng Admin</button>
            <button onclick="refreshOrders()" class="success">ğŸ”„ Refresh Tá»± Äá»™ng</button>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“‹ Káº¿t Quáº£ Test</h2>
            <div id="testResults" class="result info">ChÆ°a cÃ³ káº¿t quáº£ test nÃ o. HÃ£y táº¡o Ä‘Æ¡n hÃ ng test Ä‘á»ƒ báº¯t Ä‘áº§u.</div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“ˆ Danh SÃ¡ch ÄÆ¡n HÃ ng</h2>
            <div id="ordersList">ChÆ°a cÃ³ Ä‘Æ¡n hÃ ng nÃ o Ä‘Æ°á»£c táº£i.</div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080/api';
        let refreshInterval = null;
        
        // Táº¡o Ä‘Æ¡n hÃ ng test
        async function createTestOrder() {
            const resultDiv = document.getElementById('testResults');
            resultDiv.className = 'result info';
            resultDiv.textContent = 'ğŸ”„ Äang táº¡o Ä‘Æ¡n hÃ ng test...';
            
            try {
                const orderData = {
                    orderNumber: 'TEST' + Date.now().toString().slice(-6),
                    orderDate: new Date().toISOString(),
                    orderTotal: parseFloat(document.getElementById('orderTotal').value),
                    shippingFee: parseFloat(document.getElementById('shippingFee').value),
                    finalTotal: parseFloat(document.getElementById('orderTotal').value) + parseFloat(document.getElementById('shippingFee').value),
                    paymentMethod: 'Thanh toÃ¡n khi nháº­n hÃ ng (COD)',
                    customerInfo: {
                        firstName: document.getElementById('customerName').value.split(' ')[0] || 'Test',
                        lastName: document.getElementById('customerName').value.split(' ').slice(1).join(' ') || 'Customer',
                        email: document.getElementById('customerEmail').value,
                        phone: document.getElementById('customerPhone').value,
                        address: document.getElementById('customerAddress').value,
                        city: document.getElementById('customerCity').value,
                        district: 'Quáº­n Test',
                        note: document.getElementById('orderNote').value
                    },
                    items: [
                        {
                            id: 'TEST001',
                            name: 'Sáº£n pháº©m Test',
                            price: parseFloat(document.getElementById('orderTotal').value),
                            quantity: 1,
                            image: '/images/test-product.jpg',
                            brand: 'OneStep'
                        }
                    ],
                    paymentInfo: {
                        id: 'PAY' + Date.now(),
                        maGiaoDich: 'TXN' + Date.now(),
                        trangThai: 1,
                        phuongThucId: 1
                    }
                };
                
                console.log('ğŸ“¦ Dá»¯ liá»‡u Ä‘Æ¡n hÃ ng:', orderData);
                
                // Format dá»¯ liá»‡u cho backend
                const backendData = formatOrderForBackend(orderData);
                console.log('ğŸ”„ Dá»¯ liá»‡u gá»­i lÃªn backend:', backendData);
                
                const response = await fetch(`${API_BASE_URL}/don-hang/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('authToken') || '')
                    },
                    body: JSON.stringify(backendData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('âœ… Káº¿t quáº£ tá»« backend:', result);
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c táº¡o thÃ nh cÃ´ng!
                
ğŸ“‹ ThÃ´ng tin Ä‘Æ¡n hÃ ng:
- MÃ£ Ä‘Æ¡n: ${orderData.orderNumber}
- KhÃ¡ch hÃ ng: ${orderData.customerInfo.firstName} ${orderData.customerInfo.lastName}
- SÄT: ${orderData.customerInfo.phone}
- Email: ${orderData.customerInfo.email}
- Tá»•ng tiá»n: ${orderData.finalTotal.toLocaleString('vi-VN')} VNÄ
- Loáº¡i Ä‘Æ¡n: ONLINE (tá»« trang chá»§)
- Tráº¡ng thÃ¡i: Chá» xÃ¡c nháº­n

ğŸ”„ Backend Response:
${JSON.stringify(result, null, 2)}

â° Thá»i gian táº¡o: ${new Date().toLocaleString('vi-VN')}`;
                
                // Tá»± Ä‘á»™ng kiá»ƒm tra Ä‘Æ¡n hÃ ng trÃªn admin sau 2 giÃ¢y
                setTimeout(() => {
                    checkAdminOrders();
                }, 2000);
                
            } catch (error) {
                console.error('âŒ Lá»—i khi táº¡o Ä‘Æ¡n hÃ ng:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ Lá»—i khi táº¡o Ä‘Æ¡n hÃ ng:
                
${error.message}

ğŸ” Chi tiáº¿t lá»—i:
${error.stack || 'KhÃ´ng cÃ³ thÃ´ng tin chi tiáº¿t'}

â° Thá»i gian lá»—i: ${new Date().toLocaleString('vi-VN')}`;
            }
        }
        
        // Format dá»¯ liá»‡u Ä‘Æ¡n hÃ ng cho backend
        function formatOrderForBackend(orderData) {
            const customerInfo = orderData.customerInfo || {};
            const currentDate = new Date().toISOString().split('T')[0];
            
            return {
                // ThÃ´ng tin khÃ¡ch hÃ ng
                khachHangId: 0,
                hoTen: `${customerInfo.firstName || ''} ${customerInfo.lastName || ''}`.trim() || 'KhÃ¡ch hÃ ng',
                soDienThoai: customerInfo.phone || '',
                email: customerInfo.email || '',
                
                // ThÃ´ng tin Ä‘Æ¡n hÃ ng
                maDon: orderData.orderNumber || 'ORD' + Date.now().toString().slice(-8),
                loaiDon: 1, // 1 = ONLINE (tá»« trang chá»§)
                tongTien: parseFloat(orderData.finalTotal || orderData.orderTotal || 0),
                tongTienGoc: parseFloat(orderData.orderTotal || 0),
                tienGiam: parseFloat(orderData.discount || 0),
                tienShip: parseFloat(orderData.shippingFee || 0),
                
                // Äá»‹a chá»‰ giao hÃ ng
                diaChiGiaoHang: customerInfo.address ? 
                    `${customerInfo.address}, ${customerInfo.district}, ${getCityText(customerInfo.city)}` : '',
                
                // ThÃ´ng tin thanh toÃ¡n
                phuongThucThanhToan: orderData.paymentMethod || 'Thanh toÃ¡n khi nháº­n hÃ ng (COD)',
                
                // Tráº¡ng thÃ¡i vÃ  ngÃ y thÃ¡ng
                trangThai: 1, // 1 = Chá» xÃ¡c nháº­n
                ngayXacNhan: currentDate,
                ngayCapNhat: currentDate,
                ngayDuKien: calculateExpectedDeliveryDate(customerInfo.city),
                
                // ThÃ´ng tin khÃ¡c
                ghiChu: customerInfo.note || `ÄÆ¡n hÃ ng tá»« trang chá»§ - ${new Date().toLocaleString('vi-VN')}`,
                nguoiTao: 'KhÃ¡ch hÃ ng',
                nguoiCapNhat: 'KhÃ¡ch hÃ ng',
                daXoa: 0,
                
                // Chi tiáº¿t Ä‘Æ¡n hÃ ng
                chiTietDonHang: formatOrderItemsForBackend(orderData.items || []),
                
                // ThÃ´ng tin voucher náº¿u cÃ³
                voucherId: orderData.voucherId || 0,
                maGiamGia: orderData.discountCode || null
            };
        }
        
        // Format chi tiáº¿t Ä‘Æ¡n hÃ ng cho backend
        function formatOrderItemsForBackend(items) {
            if (!Array.isArray(items)) return [];
            
            return items.map((item, index) => ({
                id: item.id || Date.now() + index,
                tenSanPham: item.name || 'Sáº£n pháº©m',
                gia: parseFloat(item.price || 0),
                soLuong: parseInt(item.quantity || 1),
                kichCo: item.size || 'Máº·c Ä‘á»‹nh',
                mauSac: item.color || 'Máº·c Ä‘á»‹nh',
                hinhAnh: item.image || '/images/item-default.jpg',
                brand: item.brand || 'OneStep'
            }));
        }
        
        // TÃ­nh ngÃ y dá»± kiáº¿n giao hÃ ng
        function calculateExpectedDeliveryDate(city) {
            const currentDate = new Date();
            let deliveryDays = 3; // Máº·c Ä‘á»‹nh 3 ngÃ y
            
            if (city === 'hanoi' || city === 'hcm') {
                deliveryDays = 1; // Ná»™i thÃ nh HÃ  Ná»™i/HCM: 1 ngÃ y
            } else if (city === 'danang' || city === 'haiphong' || city === 'cantho') {
                deliveryDays = 2; // ThÃ nh phá»‘ lá»›n: 2 ngÃ y
            }
            
            const expectedDate = new Date(currentDate.getTime() + (deliveryDays * 24 * 60 * 60 * 1000));
            return expectedDate.toISOString().split('T')[0];
        }
        
        // Láº¥y tÃªn thÃ nh phá»‘
        function getCityText(city) {
            const cityMap = {
                'hanoi': 'HÃ  Ná»™i',
                'hcm': 'TP. Há»“ ChÃ­ Minh',
                'danang': 'ÄÃ  Náºµng',
                'haiphong': 'Háº£i PhÃ²ng',
                'cantho': 'Cáº§n ThÆ¡',
                'other': 'Tá»‰nh khÃ¡c'
            };
            return cityMap[city] || 'Tá»‰nh khÃ¡c';
        }
        
        // Kiá»ƒm tra Ä‘Æ¡n hÃ ng trÃªn admin
        async function checkAdminOrders() {
            const resultDiv = document.getElementById('testResults');
            const ordersDiv = document.getElementById('ordersList');
            
            try {
                resultDiv.className = 'result info';
                resultDiv.textContent = 'ğŸ”„ Äang kiá»ƒm tra Ä‘Æ¡n hÃ ng trÃªn admin...';
                
                const response = await fetch(`${API_BASE_URL}/don-hang/hien-thi`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('authToken') || '')
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const orders = Array.isArray(data) ? data : data.data || [];
                
                console.log('ğŸ“‹ ÄÆ¡n hÃ ng tá»« admin:', orders);
                
                // Äáº¿m Ä‘Æ¡n hÃ ng theo loáº¡i
                const onlineOrders = orders.filter(order => order.loaiDon === 1);
                const offlineOrders = orders.filter(order => order.loaiDon === 0);
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… ÄÃ£ táº£i thÃ nh cÃ´ng danh sÃ¡ch Ä‘Æ¡n hÃ ng tá»« admin!
                
ğŸ“Š Thá»‘ng kÃª:
- Tá»•ng Ä‘Æ¡n hÃ ng: ${orders.length}
- ÄÆ¡n ONLINE (tá»« trang chá»§): ${onlineOrders.length}
- ÄÆ¡n OFFLINE (táº¡i quáº§y): ${offlineOrders.length}

â° Thá»i gian kiá»ƒm tra: ${new Date().toLocaleString('vi-VN')}`;
                
                // Hiá»ƒn thá»‹ danh sÃ¡ch Ä‘Æ¡n hÃ ng
                displayOrders(orders);
                
            } catch (error) {
                console.error('âŒ Lá»—i khi kiá»ƒm tra Ä‘Æ¡n hÃ ng:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ Lá»—i khi kiá»ƒm tra Ä‘Æ¡n hÃ ng:
                
${error.message}

â° Thá»i gian lá»—i: ${new Date().toLocaleString('vi-VN')}`;
            }
        }
        
        // Hiá»ƒn thá»‹ danh sÃ¡ch Ä‘Æ¡n hÃ ng
        function displayOrders(orders) {
            const ordersDiv = document.getElementById('ordersList');
            
            if (orders.length === 0) {
                ordersDiv.innerHTML = '<p>ChÆ°a cÃ³ Ä‘Æ¡n hÃ ng nÃ o.</p>';
                return;
            }
            
            // Sáº¯p xáº¿p theo ngÃ y táº¡o má»›i nháº¥t
            orders.sort((a, b) => new Date(b.ngayCapNhat) - new Date(a.ngayCapNhat));
            
            const ordersHTML = orders.map(order => {
                const statusClass = getStatusClass(order.trangThai);
                const statusLabel = getStatusLabel(order.trangThai);
                const typeClass = order.loaiDon === 1 ? 'online' : 'offline';
                const typeLabel = order.loaiDon === 1 ? 'ONLINE' : 'OFFLINE';
                
                return `
                    <div class="order-item ${typeClass}">
                        <div class="order-header">
                            ${order.maDon} 
                            <span class="status-badge status-${statusClass}">${statusLabel}</span>
                            <span class="type-badge type-${typeClass}">${typeLabel}</span>
                        </div>
                        <div class="order-details">
                            <strong>KhÃ¡ch hÃ ng:</strong> ${order.hoTen}<br>
                            <strong>SÄT:</strong> ${order.soDienThoai}<br>
                            <strong>Email:</strong> ${order.email || 'ChÆ°a cÃ³'}<br>
                            <strong>Tá»•ng tiá»n:</strong> ${parseFloat(order.tongTien).toLocaleString('vi-VN')} VNÄ<br>
                            <strong>NgÃ y táº¡o:</strong> ${new Date(order.ngayCapNhat).toLocaleString('vi-VN')}<br>
                            <strong>Äá»‹a chá»‰:</strong> ${order.diaChiGiaoHang || 'ChÆ°a cÃ³'}<br>
                            <strong>Ghi chÃº:</strong> ${order.ghiChu || 'KhÃ´ng cÃ³'}
                        </div>
                    </div>
                `;
            }).join('');
            
            ordersDiv.innerHTML = ordersHTML;
        }
        
        // Láº¥y class CSS cho tráº¡ng thÃ¡i
        function getStatusClass(trangThai) {
            switch (trangThai) {
                case 1: return 'pending';
                case 2: return 'confirmed';
                case 3: return 'shipping';
                case 4: return 'delivering';
                case 5: return 'done';
                case 6: return 'cancel';
                default: return 'pending';
            }
        }
        
        // Láº¥y label cho tráº¡ng thÃ¡i
        function getStatusLabel(trangThai) {
            switch (trangThai) {
                case 1: return 'Chá» xÃ¡c nháº­n';
                case 2: return 'ÄÃ£ xÃ¡c nháº­n';
                case 3: return 'Chá» giao';
                case 4: return 'Äang giao';
                case 5: return 'HoÃ n thÃ nh';
                case 6: return 'ÄÃ£ há»§y';
                default: return 'KhÃ´ng xÃ¡c Ä‘á»‹nh';
            }
        }
        
        // Refresh tá»± Ä‘á»™ng
        function refreshOrders() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(() => {
                checkAdminOrders();
            }, 10000); // Refresh má»—i 10 giÃ¢y
            
            document.getElementById('testResults').className = 'result info';
            document.getElementById('testResults').textContent = 'ğŸ”„ ÄÃ£ báº­t cháº¿ Ä‘á»™ refresh tá»± Ä‘á»™ng má»—i 10 giÃ¢y. Nháº¥n "Kiá»ƒm Tra ÄÆ¡n HÃ ng Admin" Ä‘á»ƒ táº¯t.';
        }
        
        // XÃ³a káº¿t quáº£
        function clearResults() {
            document.getElementById('testResults').className = 'result info';
            document.getElementById('testResults').textContent = 'ChÆ°a cÃ³ káº¿t quáº£ test nÃ o. HÃ£y táº¡o Ä‘Æ¡n hÃ ng test Ä‘á»ƒ báº¯t Ä‘áº§u.';
            document.getElementById('ordersList').innerHTML = 'ChÆ°a cÃ³ Ä‘Æ¡n hÃ ng nÃ o Ä‘Æ°á»£c táº£i.';
            
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        // Tá»± Ä‘á»™ng kiá»ƒm tra khi trang load
        window.onload = function() {
            checkAdminOrders();
        };
    </script>
</body>
</html>
